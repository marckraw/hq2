name: PR Validation

on:
  pull_request:
    branches: [master, develop]

jobs:
  validate-all:
    name: Complete Validation Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: üîç TypeScript validation
        run: |
          echo "üîç Running TypeScript validation..."
          npm install
          npm run type-check
          echo "‚úÖ TypeScript validation passed"

      - name: üßπ ESLint validation
        run: |
          echo "üßπ Running ESLint validation..."
          npm run lint
          echo "‚úÖ ESLint validation passed"

      - name: üèóÔ∏è Build validation
        run: |
          echo "üèóÔ∏è Running build validation..."
          npm run build
          echo "‚úÖ Build validation passed"

      - name: üß™ Test validation
        env:
          NODE_ENV: test
          PORT: 3000
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          LEONARDOAI_API_KEY: ${{ secrets.LEONARDOAI_API_KEY }}
          FIGMA_API_KEY: ${{ secrets.FIGMA_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          TODOIST_API_TOKEN: ${{ secrets.TODOIST_API_TOKEN }}
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HQ_SLACK_SECRET: ${{ secrets.HQ_SLACK_SECRET }}
          SLACK_BOT_URL: ${{ secrets.SLACK_BOT_URL }}
          STORYBLOK_OAUTH_TOKEN: ${{ secrets.STORYBLOK_OAUTH_TOKEN }}
          STORYBLOK_ACCESS_TOKEN: ${{ secrets.STORYBLOK_ACCESS_TOKEN }}
          QDRANT__SERVICE__URL: ${{ secrets.QDRANT__SERVICE__URL }}
          QDRANT__SERVICE__PORT: ${{ secrets.QDRANT__SERVICE__PORT }}
          QDRANT__SERVICE__API_KEY: ${{ secrets.QDRANT__SERVICE__API_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
          LANGFUSE_ENABLED: ${{ secrets.LANGFUSE_ENABLED }}
          LANGFUSE_FLUSH_AT: ${{ secrets.LANGFUSE_FLUSH_AT }}
          LANGFUSE_FLUSH_INTERVAL: ${{ secrets.LANGFUSE_FLUSH_INTERVAL }}
        run: |
          echo "üß™ Running unit tests..."
          npm run test:run
          echo "‚úÖ Test validation passed"

      - name: ü§ñ AI Evals validation
        env:
          NODE_ENV: test
          PORT: 3000
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          LEONARDOAI_API_KEY: ${{ secrets.LEONARDOAI_API_KEY }}
          FIGMA_API_KEY: ${{ secrets.FIGMA_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          TODOIST_API_TOKEN: ${{ secrets.TODOIST_API_TOKEN }}
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HQ_SLACK_SECRET: ${{ secrets.HQ_SLACK_SECRET }}
          SLACK_BOT_URL: ${{ secrets.SLACK_BOT_URL }}
          STORYBLOK_OAUTH_TOKEN: ${{ secrets.STORYBLOK_OAUTH_TOKEN }}
          STORYBLOR_ACCESS_TOKEN: ${{ secrets.STORYBLOK_ACCESS_TOKEN }}
          QDRANT__SERVICE__URL: ${{ secrets.QDRANT__SERVICE__URL }}
          QDRANT__SERVICE__PORT: ${{ secrets.QDRANT__SERVICE__PORT }}
          QDRANT__SERVICE__API_KEY: ${{ secrets.QDRANT__SERVICE__API_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
          LANGFUSE_ENABLED: ${{ secrets.LANGFUSE_ENABLED }}
          LANGFUSE_FLUSH_AT: ${{ secrets.LANGFUSE_FLUSH_AT }}
          LANGFUSE_FLUSH_INTERVAL: ${{ secrets.LANGFUSE_FLUSH_INTERVAL }}
        run: |
          echo "ü§ñ Running AI evaluations..."
          cd packages/thegrid
          npm run eval:evalite:ci
          echo "‚úÖ AI Evals validation passed"

      - name: üéØ Combined check
        run: |
          echo "üéØ Running combined validation check..."
          npm run check
          echo "‚úÖ All validations passed"

      - name: üìä Validation Summary
        run: |
          echo "üìä === Validation Summary ==="
          echo "‚úÖ TypeScript: PASSED"
          echo "‚úÖ ESLint: PASSED" 
          echo "‚úÖ Build: PASSED"
          echo "‚úÖ Tests: PASSED"
          echo "‚úÖ AI Evals: PASSED"
          echo "‚úÖ Combined Check: PASSED"
          echo "üéâ Ready for review!"
